name: Test Unity Version Detection ğŸ§ª

on:
  workflow_dispatch:
    inputs:
      unity_major_version:
        description: 'Unity major version to test (e.g. 6000, 2023)'
        required: false
        default: '6000'
        type: string

jobs:
  test-detection:
    name: "ğŸ§ª Test Unity Version Detection"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Test Unity Version Detection
        run: |
          echo "ğŸ§ª Testing Unity version detection for ${{ github.event.inputs.unity_major_version || '6000' }}"
          
          MAIN_UNITY_VERSION="${{ github.event.inputs.unity_major_version || '6000' }}"
          
          echo "ğŸ” Fetching Unity releases for version $MAIN_UNITY_VERSION..."
          
          echo "ğŸ“¡ Making GraphQL request to Unity API..."
          OUT=$(
            curl 'https://services.unity.com/graphql' -s \
              --compressed \
              -X POST \
              -H 'content-type: application/json' \
              --data-raw '{"operationName":"GetRelease","variables":{"version":"'${MAIN_UNITY_VERSION}'","limit":50},"query":"query GetRelease($limit: Int, $skip: Int, $version: String!, $stream: [UnityReleaseStream!]) {\n  getUnityReleases(\n    limit: $limit\n    skip: $skip\n    stream: $stream\n    version: $version\n    entitlements: [XLTS]\n  ) {\n    totalCount\n    edges {\n      node {\n        version\n        entitlements\n        releaseDate\n        unityHubDeepLink\n        stream\n        __typename\n      }\n      __typename\n    }\n    __typename\n  }\n}"}'
          )
          
          if [[ $? -ne 0 ]] || [[ -z "$OUT" ]]; then
            echo "âŒ Failed to fetch Unity releases or empty response"
            exit 1
          fi
          
          echo "ğŸ“Š Raw API response (first 500 chars):"
          echo "$OUT" | head -c 500
          echo ""
          echo ""
          
          # Check if API response contains errors
          if echo "$OUT" | jq -e '.errors' >/dev/null 2>&1; then
            echo "âŒ Unity API returned errors:"
            echo "$OUT" | jq '.errors'
            exit 1
          fi
          
          # Check if data exists
          if ! echo "$OUT" | jq -e '.data.getUnityReleases.edges' >/dev/null 2>&1; then
            echo "âŒ No Unity releases data found in response"
            echo "Full response: $OUT"
            exit 1
          fi
          
          echo "ğŸ“‹ Available Unity $MAIN_UNITY_VERSION versions:"
          echo "$OUT" | jq -r '.data.getUnityReleases.edges[]?.node | "\(.version) - \(.stream) - \(.releaseDate)"' | head -10
          
          echo ""
          echo "ğŸ¯ Detecting latest stable version:"
          
          # Try SUPPORTED versions first
          LTS=$(echo "$OUT" | jq -r '.data.getUnityReleases.edges[]?.node | select(.stream | contains("SUPPORTED"))' 2>/dev/null || echo "")
          
          if [[ -z "$LTS" ]]; then
            echo "âš ï¸ No SUPPORTED versions found, trying LTS..."
            LTS=$(echo "$OUT" | jq -r '.data.getUnityReleases.edges[]?.node | select(.stream | contains("LTS"))' 2>/dev/null || echo "")
          fi
          
          if [[ -z "$LTS" ]]; then
            echo "âš ï¸ No LTS versions found, taking first stable version..."
            LTS=$(echo "$OUT" | jq -r '.data.getUnityReleases.edges[]?.node | select(.stream != "ALPHA" and .stream != "BETA")' 2>/dev/null | head -1)
          fi
          
          LATEST_VERSION=$(echo "$LTS" | jq --slurp -r '.[0].version // empty' 2>/dev/null)
          
          if [[ -z "$LATEST_VERSION" ]] || [[ "$LATEST_VERSION" == "null" ]]; then
            echo "âŒ No suitable version found"
            echo "Available versions:"
            echo "$OUT" | jq -r '.data.getUnityReleases.edges[]?.node | "\(.version) - \(.stream)"' | head -5
            exit 1
          fi
          
          echo "âœ… Selected Unity version: $LATEST_VERSION"
          
          echo ""
          echo "ğŸ” Checking Unity CI availability for $LATEST_VERSION..."
          
          DOCKER_RESPONSE=$(curl -s "https://hub.docker.com/v2/repositories/unityci/editor/tags?page_size=25&page=1&ordering=last_updated&name=${LATEST_VERSION}")
          echo "ğŸ“Š Docker Hub API response sample:"
          echo "$DOCKER_RESPONSE" | head -200
          echo ""
          
          UNITY_CI_COUNT=$(echo "$DOCKER_RESPONSE" | jq -r '.count // 0' 2>/dev/null || echo "0")
          
          echo "ğŸ“Š Unity CI images found: $UNITY_CI_COUNT"
          
          if [[ $UNITY_CI_COUNT -gt 0 ]]; then
            echo "âœ… Unity CI images are available!"
          else
            echo "âš ï¸ No Unity CI images found for this version"
            echo "Check: https://hub.docker.com/r/unityci/editor/tags?name=${LATEST_VERSION}"
          fi
          
          # Generate test repo version
          REPO_VERSION=$(date +"%Y.%m.%d.%H%M")
          
          echo ""
          echo "## ğŸ“‹ Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Unity Major Version:** $MAIN_UNITY_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest Supported Version:** $LATEST_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Unity CI Images Available:** $UNITY_CI_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Generated Repo Version:** $REPO_VERSION" >> $GITHUB_STEP_SUMMARY
          
          if [[ $UNITY_CI_COUNT -gt 0 ]]; then
            echo "- **Status:** âœ… Ready for build" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** âš ï¸ Unity CI images not available" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Test Script Locally
        run: |
          echo "ğŸ§ª Testing unity-version-manager.sh script..."
          
          if [[ -f "./scripts/unity-version-manager.sh" ]]; then
            echo "âœ… Script found"
            chmod +x ./scripts/unity-version-manager.sh
            
            echo "ğŸ” Testing latest version detection..."
            ./scripts/unity-version-manager.sh latest ${{ github.event.inputs.unity_major_version || '6000' }}
            
            echo ""
            echo "ğŸ“‹ Testing version listing (top 5)..."
            ./scripts/unity-version-manager.sh versions ${{ github.event.inputs.unity_major_version || '6000' }} | head -5
          else
            echo "âŒ Script not found at ./scripts/unity-version-manager.sh"
            exit 1
          fi
